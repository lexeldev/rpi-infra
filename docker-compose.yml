services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566" # Edge port for all AWS services
      - "8080:8080"
    environment:
      # LocalStack core config
      - SERVICES=${LOCALSTACK_SERVICES}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}
      # Persist state across restarts (queues, buckets, etc.)
      - PERSISTENCE=1
    volumes:
      - localstack-data:/var/lib/localstack
      # Init scripts that run when LocalStack is ready
      - ./localstack-init:/etc/localstack/init/ready.d
    restart: unless-stopped

  tvoc-collector:
    # Python app: reads TVOC sensor and sends messages to SQS
    build:
      # This path is relative to the rpi-infra directory on the Raspberry Pi.
      # It assumes the repo rpi-tvoc-collector is cloned into ../rpi-tvoc-collector
      context: ../rpi-tvoc-collector
      dockerfile: Dockerfile
    container_name: tvoc-collector
    depends_on:
      - localstack
    environment:
      # AWS SDK configuration to talk to LocalStack
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_ENDPOINT_URL=${AWS_SQS_ENDPOINT}
      - SENSOR_QUEUE_URL=${TVOC_SQS_QUEUE_URL}
      # GPIO in container through mock pin factory
      - GPIOZERO_PIN_FACTORY=${GPIOZERO_PIN_FACTORY}
    # Allow access to UART for the TVOC sensor (adjust device if needed)
    devices:
      - "/dev/ttyAMA0:/dev/ttyAMA0"
    privileged: true
    restart: unless-stopped

  tvoc-processor:
    build:
      context: ../rpi-tvoc-processor
    container_name: tvoc-processor
    depends_on:
      - localstack
      - influxdb
    environment:
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_SQS_ENDPOINT=${AWS_SQS_ENDPOINT}
      - SENSOR_QUEUE_NAME=${TVOC_SQS_QUEUE_NAME}
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TVOC_ALERT_THRESHOLD=${TVOC_ALERT_THRESHOLD}
      - CO2_ALERT_THRESHOLD=${CO2_ALERT_THRESHOLD}
      - INFLUXDB_ENABLED=${INFLUXDB_ENABLED}
      - INFLUX_URL=${INFLUXDB_URL}
      - INFLUX_ORG=${INFLUXDB_ORG}
      - INFLUX_BUCKET=${INFLUXDB_BUCKET}
      - INFLUX_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    restart: unless-stopped

  influxdb:
    image: influxdb:2.7
    container_name: influxdb
    restart: unless-stopped
    ports:
      - "${INFLUXDB_PORT}:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=${INFLUXDB_USERNAME}
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD}
      - DOCKER_INFLUXDB_INIT_ORG=${INFLUXDB_ORG}
      - DOCKER_INFLUXDB_INIT_BUCKET=${INFLUXDB_BUCKET}
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_ADMIN_TOKEN}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2

  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana-data:/var/lib/grafana
    depends_on:
      - influxdb

volumes:
  localstack-data:
  influxdb-data:
  influxdb-config:
  grafana-data:
