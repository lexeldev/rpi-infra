services:
  localstack:
    image: localstack/localstack:latest
    container_name: localstack
    ports:
      - "4566:4566" # Edge port for all AWS services
      - "8080:8080"
    environment:
      # LocalStack core config
      - SERVICES=${LOCALSTACK_SERVICES}
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN}
      # Persist state across restarts (queues, buckets, etc.)
      - PERSISTENCE=1
    volumes:
      - localstack-data:/var/lib/localstack
      # Init scripts that run when LocalStack is ready
      - ./localstack-init:/etc/localstack/init/ready.d
    restart: unless-stopped

  tvoc-collector:
    # Python app: reads TVOC sensor and sends messages to SQS
    build:
      # This path is relative to the rpi-infra directory on the Raspberry Pi.
      # It assumes the repo rpi-tvoc-collector is cloned into ../rpi-tvoc-collector
      context: ../rpi-tvoc-collector
      dockerfile: Dockerfile
    container_name: tvoc-collector
    depends_on:
      - localstack
    environment:
      # AWS SDK configuration to talk to LocalStack
      - AWS_REGION=${AWS_REGION}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_ENDPOINT_URL=http://localstack:4566
      # Collector gets full QueueUrl from infra (.env)
      - SENSOR_QUEUE_URL=${TVOC_SQS_QUEUE_URL}
      # GPIO in container through mock pin factory
      - GPIOZERO_PIN_FACTORY=${GPIOZERO_PIN_FACTORY}
    # Allow access to UART for the TVOC sensor (adjust device if needed)
    devices:
      - "/dev/ttyAMA0:/dev/ttyAMA0"
    privileged: true
    restart: unless-stopped

  tvoc-processor:
    build:
      context: ../rpi-tvoc-processor
    container_name: tvoc-processor
    depends_on:
      - localstack
    environment:
      - AWS_REGION=us-east-1
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - AWS_SQS_ENDPOINT=http://localstack:4566
      - SENSOR_QUEUE_NAME=tvoc-events
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - TELEGRAM_CHAT_ID=${TELEGRAM_CHAT_ID}
      - TVOC_ALERT_THRESHOLD=2.0
      - CO2_ALERT_THRESHOLD=1000

volumes:
  localstack-data: